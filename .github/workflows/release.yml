name: Build Release DMG

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-dmg:
    runs-on: macos-13

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: Install dependencies
        run: |
          brew install create-dmg
          gem install xcpretty

      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Release
        run: |
          chmod +x scripts/build-release.sh
          ./scripts/build-release.sh
        env:
          CONFIGURATION: Release

      - name: Create DMG
        run: |
          chmod +x scripts/create-dmg.sh
          ./scripts/create-dmg.sh

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: WinampSpotifyPlayer-${{ steps.get_version.outputs.version }}
          path: |
            build/WinampSpotifyPlayer.dmg
            build/WinampSpotifyPlayer_dmg_checksum.txt
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/WinampSpotifyPlayer.dmg
            build/WinampSpotifyPlayer_dmg_checksum.txt
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## üéâ WinampSpotifyPlayer v${{ steps.get_version.outputs.version }}

            A Winamp-inspired Spotify player for macOS.

            ### üì• Installation

            1. Download `WinampSpotifyPlayer.dmg`
            2. Open the DMG file
            3. Drag **WinampSpotifyPlayer.app** to your Applications folder
            4. Configure Spotify credentials (see Installation Guide)
            5. Launch and enjoy!

            ### ‚úÖ Verified Download

            Verify DMG integrity using the checksum file:
            ```bash
            shasum -a 256 -c WinampSpotifyPlayer_dmg_checksum.txt
            ```

            ### üìã Requirements

            - macOS 12.0 (Monterey) or later
            - Spotify Premium account
            - Spotify Developer credentials (free)

            ### üìö Documentation

            - [Installation Guide](https://github.com/Viniciuscarvalho/WinampSpotifyPlayer/blob/main/INSTALL.md)
            - [Setup Instructions](https://github.com/Viniciuscarvalho/WinampSpotifyPlayer/blob/main/SETUP.md)
            - [README](https://github.com/Viniciuscarvalho/WinampSpotifyPlayer/blob/main/README.md)

            ### üêõ Known Issues

            - First launch may require right-click ‚Üí Open due to Gatekeeper
            - Media keys require Accessibility permission

            ---

            Built with ‚ù§Ô∏è for Winamp nostalgia
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
